<project name="selenium-grid" default="launch-selenium-rc" basedir=".">

  <property environment="env"/>
  <exec executable="hostname" osfamily="unix" failifexecutionfails="false" outputproperty="env.COMPUTERNAME"/>
  <property name="env.HOSTNAME" value="${env.COMPUTERNAME}"/> <!-- Windows vs. Linux -->

  <property file="${basedir}/${env.HOSTNAME}.project.properties" />
  <property file="${basedir}/project.properties"/>

  <path id="selenium.classpath">
    <pathelement path="${basedir}/"/>
    <fileset dir="${basedir}/lib">
      <include name="selenium-server-standalone-${selenium.version}.jar"/>
    </fileset>
    <pathelement path="${java.class.path}/"/>
  </path>

  <!-- Debug target to show variables -->
  <target name="debug">
    <echoproperties/>
  </target>

  <target name="launch-hub" description="Launch Selenium Hub">
    <java classname="org.openqa.grid.selenium.GridLauncher"
          classpathref="selenium.classpath"
          fork="true"
          failonerror="true">
      <arg value="-role"/>
      <arg value="hub"/>
      <arg value="-port"/>
      <arg value="${hub.port}"/>
    </java>
  </target>

  <target name="launch-webdriver">
    <fail unless="webdriver.browsers" message="Property webdriver.browsers must be set in ${env.HOSTNAME}.project.properties" /> 
    <java classpathref="selenium.classpath"
          classname="org.openqa.grid.selenium.GridLauncher"
          fork="true"
          failonerror="true">
      <arg value="-role"/>
      <arg value="webdriver"/>
      <arg value="-port"/>
      <arg value="${webdriver.port}"/>
      <arg value="-hub"/>
      <arg value="http://${hub.host}:${hub.port}/grid/register"/>
      <arg value="-nodeTimeout"/>
      <arg value="${node.timeout}"/>
      <arg value="-maxConcurrent"/>
      <arg value="${node.max.concurrent}"/>
      <arg line="${webdriver.browsers}"/>
    </java>
  </target>

  <target name="launch-remote-control"
          description="Launch A Remote Control"
          depends="check-remote-control-properties, launch-remote-control-with-custom-profile, launch-remote-control-without-custom-profile"/>

  <target name="check-remote-control-properties">
    <fail unless="node.host" message="Property node.host must be set in ${env.HOSTNAME}.project.properties" /> 
    <fail unless="rc.browsers" message="Property rc.browsers must be set in ${env.HOSTNAME}.project.properties" /> 
  </target>

  <target name="check-for-custom-profile">
    <condition property="use.custom.profile">
      <not>
        <equals arg1="${custom.firefox.profile}" arg2="" />
      </not>
    </condition>
  </target>

  <target name="launch-remote-control-with-custom-profile" depends="check-for-custom-profile" if="use.custom.profile">
    <java classpathref="selenium.classpath"
          classname="org.openqa.grid.selenium.GridLauncher"
          fork="true"
          failonerror="true">
      <arg value="-role"/>
      <arg value="rc"/>
      <arg value="-port"/>
      <arg value="${rc.port}"/>
      <arg value="-host"/>
      <arg value="${node.host}"/>
      <arg value="-hub"/>
      <arg value="http://${hub.host}:${hub.port}/grid/register"/>
      <arg value="-nodeTimeout"/>
      <arg value="${node.timeout}"/>
      <arg value="-maxConcurrent"/>
      <arg value="${node.max.concurrent}"/>
      <arg line="${rc.browsers}"/>
      <arg value="-firefoxProfileTemplate"/>
      <arg value="${basedir}${file.separator}firefoxprofiles${file.separator}${custom.firefox.profile}"/>
      <arg line="${rc.arguments}"/>
    </java>
  </target>

  <target name="launch-remote-control-without-custom-profile" depends="check-for-custom-profile" unless="use.custom.profile">
    <java classpathref="remote-control.classpath"
          classname="org.openqa.grid.selenium.GridLauncher"
          fork="true"
          failonerror="true">
      <arg value="-role"/>
      <arg value="rc"/>
      <arg value="-port"/>
      <arg value="${rc.port}"/>
      <arg value="-host"/>
      <arg value="${node.host}"/>
      <arg value="-hub"/>
      <arg value="http://${hub.host}:${hub.port}/grid/register"/>
      <arg value="-nodeTimeout"/>
      <arg value="${node.timeout}"/>
      <arg value="-maxConcurrent"/>
      <arg value="${node.max.concurrent}"/>
      <arg line="${rc.browsers}"/>
      <arg line="${rc.arguments}"/>
    </java>
  </target>

</project>
